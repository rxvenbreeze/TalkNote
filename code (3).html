<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Audio Note Taker (GitHub Pages Ready)</title>
    <style>
        /* --- Modern Minimalist Styles (Same as previous good version) --- */
        *, *::before, *::after { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            background-color: #f4f6f8;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh; /* Ensure footer (if any) is at bottom */
        }

        .app-container {
            width: 100%;
            max-width: 850px;
            margin: 20px auto;
            background-color: #ffffff;
            padding: 25px 30px;
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.07);
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-top: 0;
            margin-bottom: 30px;
            font-size: 2.2em;
            font-weight: 600;
        }

        h2 {
            color: #34495e;
            margin-top: 30px;
            margin-bottom: 15px;
            font-size: 1.6em;
            font-weight: 500;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
        }

        .control-group {
            margin-bottom: 25px;
            padding: 20px;
            background-color: #fdfdfd;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #495057;
        }

        input[type="password"],
        input[type="text"] { /* Combined for consistency */
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            background-color: #fff;
        }
        input[type="password"]:focus,
        input[type="text"]:focus {
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.20);
            outline: none;
        }

        .button-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 15px;
        }

        button {
            padding: 10px 18px;
            font-size: 0.95rem;
            font-weight: 500;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        button:hover:not(:disabled) { /* Apply hover only if not disabled */
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
        }
        button:active:not(:disabled) { /* Apply active only if not disabled */
            transform: translateY(0px);
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        button:disabled {
            background-color: #e9ecef !important;
            color: #6c757d !important;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Specific button colors */
        #startButton { background-color: #28a745; }
        #startButton:hover:not(:disabled) { background-color: #218838; }
        #stopButton { background-color: #dc3545; }
        #stopButton:hover:not(:disabled) { background-color: #c82333; }
        
        #newSectionButton { background-color: #6f42c1; }
        #newSectionButton:hover:not(:disabled) { background-color: #5a32a3; }
        #organizeButton { background-color: #fd7e14; }
        #organizeButton:hover:not(:disabled) { background-color: #e6690b; }

        #clearButton, #clearApiKeyButton { background-color: #ffc107; color: #212529; }
        #clearButton:hover:not(:disabled), #clearApiKeyButton:hover:not(:disabled) { background-color: #e0a800; }
        
        #downloadRawButton, #downloadOrganizedButton, #saveApiKeyButton { background-color: #007bff; }
        #downloadRawButton:hover:not(:disabled), #downloadOrganizedButton:hover:not(:disabled), #saveApiKeyButton:hover:not(:disabled) { background-color: #0056b3; }

        textarea {
            width: 100%;
            min-height: 220px;
            padding: 12px 15px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 0.95rem;
            line-height: 1.5;
            resize: vertical;
            margin-bottom: 10px;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        textarea:focus {
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.20);
            outline: none;
        }

        /* Status Messages */
        .status-message {
            text-align: center;
            margin: 15px 0;
            padding: 12px 15px;
            border-radius: 6px;
            font-size: 0.9em;
            border: 1px solid transparent;
        }
        #status { /* Speech status */
            background-color: #e7f3fe; 
            color: #0c5460;
            border-color: #b8daff;
        }
        #geminiStatus { /* Gemini status */
            background-color: #d1ecf1; /* Lighter blue for info */
            color: #0c5460;
            border-color: #bee5eb;
        }
        #geminiStatus.success {
            background-color: #d4edda; /* Bootstrap success light green */
            color: #155724;
            border-color: #c3e6cb;
        }
        #geminiStatus.error { /* For Gemini errors */
            background-color: #f8d7da; /* Bootstrap danger light red */
            color: #721c24;
            border-color: #f5c6cb;
        }
        #apiKeyStatus {
            font-size: 0.85em;
            text-align: center;
            color: #6c757d;
            margin-top: 8px;
        }

        .notes-group {
            margin-bottom: 30px;
        }

        /* Simple Footer */
        .app-footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
            font-size: 0.85em;
            color: #6c757d;
        }
        .app-footer a {
            color: #007bff;
            text-decoration: none;
        }
        .app-footer a:hover {
            text-decoration: underline;
        }

    </style>
    <!-- SDK import will be handled by script type="module" -->
</head>
<body>
    <div class="app-container">
        <h1>AI Enhanced Audio Note Taker</h1>

        <div class="control-group">
            <h2>Configuration</h2>
            <label for="apiKey">Gemini API Key (Required for AI Features):</label>
            <input type="password" id="apiKey" placeholder="Enter your Gemini API Key here">
            <p id="apiKeyStatus">API Key is stored in your browser's local storage. It is NOT sent anywhere else except directly to Google's API during organization.</p>
            <div class="button-bar">
                <button id="saveApiKeyButton">Save Key</button>
                <button id="clearApiKeyButton">Clear Saved Key</button>
            </div>
        </div>

        <div class="control-group">
            <h2>Voice Recording</h2>
            <div class="button-bar">
                <button id="startButton">Start Recording</button>
                <button id="stopButton" disabled>Stop Recording</button>
                <button id="newSectionButton" disabled>New Section Marker</button>
            </div>
            <p id="status" class="status-message">Status: Idle. Enter API Key & Click "Start Recording".</p>
        </div>
        
        <div class="notes-group">
            <h2>Raw Transcribed Notes</h2>
            <textarea id="notesArea" placeholder="Your transcribed notes will appear here..."></textarea>
            <div class="button-bar">
                <button id="clearButton">Clear Raw Notes</button>
                <button id="downloadRawButton">Download Raw Notes</button>
            </div>
        </div>

        <div class="notes-group">
            <h2>Organized Notes (via Gemini)</h2>
            <div class="button-bar" style="margin-bottom: 15px;">
                 <button id="organizeButton" disabled>Organize with Gemini</button>
            </div>
            <p id="geminiStatus" class="status-message">Status: Waiting for raw notes to organize.</p>
            <textarea id="organizedNotesArea" placeholder="Organized notes will appear here after processing with Gemini..." readonly></textarea>
            <div class="button-bar">
                 <button id="downloadOrganizedButton">Download Organized Notes</button>
            </div>
        </div>

        <footer class="app-footer">
            <p>AI Audio Note Taker | Created with HTML, CSS, JavaScript & Google Gemini API.</p>
            <p>Note: Your API Key and transcribed text are processed client-side. Organization uses Google's API.</p>
        </footer>
    </div>

    <script type="module">
        let GoogleGenerativeAI;
        const geminiStatusEl = document.getElementById('geminiStatus'); // Define early for SDK load status

        try {
            const genAIModule = await import('https://esm.run/@google/generative-ai');
            GoogleGenerativeAI = genAIModule.GoogleGenerativeAI;
            if (GoogleGenerativeAI) {
                geminiStatusEl.textContent = "AI SDK loaded successfully. Enter API key to enable Gemini features.";
                geminiStatusEl.classList.remove('error'); // Ensure no error class from previous state
            }
        } catch (e) {
            console.error("CRITICAL: Error loading GoogleGenerativeAI SDK:", e);
            geminiStatusEl.textContent = "Error loading Google AI SDK. AI features will be unavailable. Ensure you are online and try refreshing. Check browser console (F12) for more details.";
            geminiStatusEl.classList.add('error');
            document.getElementById('organizeButton').disabled = true;
            if(document.getElementById('apiKey')) document.getElementById('apiKey').disabled = true;
            if(document.getElementById('saveApiKeyButton')) document.getElementById('saveApiKeyButton').disabled = true;
        }

        // DOM Elements
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const newSectionButton = document.getElementById('newSectionButton');
        const clearButton = document.getElementById('clearButton');
        const downloadRawButton = document.getElementById('downloadRawButton');
        const notesArea = document.getElementById('notesArea');
        const statusDiv = document.getElementById('status');

        const apiKeyInput = document.getElementById('apiKey');
        const saveApiKeyButton = document.getElementById('saveApiKeyButton');
        const clearApiKeyButton = document.getElementById('clearApiKeyButton');
        const apiKeyStatus = document.getElementById('apiKeyStatus');
        const organizeButton = document.getElementById('organizeButton');
        // geminiStatusEl already defined
        const organizedNotesArea = document.getElementById('organizedNotesArea');
        const downloadOrganizedButton = document.getElementById('downloadOrganizedButton');

        let SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        let isRecording = false;
        let genAIInstance;

        // --- API Key Management ---
        function loadApiKey() {
            const savedKey = localStorage.getItem('geminiApiKey');
            if (savedKey && apiKeyInput) { // Check if apiKeyInput exists
                apiKeyInput.value = savedKey;
                apiKeyStatus.textContent = "API Key loaded from local storage.";
                if (GoogleGenerativeAI) initializeGemini();
            } else if (apiKeyInput) { // Check if apiKeyInput exists
                apiKeyStatus.textContent = "Enter API Key to enable AI features. It will be stored in your browser's local storage.";
            }
        }

        if (saveApiKeyButton) {
            saveApiKeyButton.addEventListener('click', () => {
                const key = apiKeyInput.value.trim();
                if (key) {
                    localStorage.setItem('geminiApiKey', key);
                    apiKeyStatus.textContent = "API Key saved to local storage.";
                    if (GoogleGenerativeAI) initializeGemini();
                    else {
                        geminiStatusEl.textContent = "API Key saved, but AI SDK failed to load. Please refresh or check console.";
                        geminiStatusEl.classList.add('error');
                    }
                } else {
                    alert("Please enter an API Key.");
                }
            });
        }

        if (clearApiKeyButton) {
            clearApiKeyButton.addEventListener('click', () => {
                localStorage.removeItem('geminiApiKey');
                if(apiKeyInput) apiKeyInput.value = '';
                apiKeyStatus.textContent = "Saved API Key cleared. Enter new key.";
                genAIInstance = null;
                organizeButton.disabled = true;
                geminiStatusEl.textContent = "API Key cleared. Gemini features disabled until a new key is provided.";
                geminiStatusEl.classList.remove('error', 'success');
            });
        }
        
        function initializeGemini() {
            if (!GoogleGenerativeAI) {
                geminiStatusEl.textContent = "Gemini SDK not loaded. Cannot initialize AI features.";
                geminiStatusEl.classList.add('error');
                organizeButton.disabled = true;
                return false; // Indicate failure
            }
            const apiKey = apiKeyInput.value.trim();
            if (apiKey) {
                try {
                    genAIInstance = new GoogleGenerativeAI(apiKey);
                    geminiStatusEl.textContent = "Gemini initialized. Ready to organize notes.";
                    geminiStatusEl.classList.remove('error');
                    geminiStatusEl.classList.add('success'); // Add success class
                    organizeButton.disabled = notesArea.value.trim().length === 0;
                    return true; // Indicate success
                } catch (error) {
                    console.error("Error initializing Gemini:", error);
                    geminiStatusEl.textContent = `Error initializing Gemini: ${error.message}. Check API Key & console.`;
                    geminiStatusEl.classList.add('error');
                    organizeButton.disabled = true;
                    return false; // Indicate failure
                }
            } else {
                geminiStatusEl.textContent = "API Key is missing. Please enter your Gemini API Key.";
                geminiStatusEl.classList.remove('error', 'success');
                organizeButton.disabled = true;
                return false; // Indicate missing key
            }
        }

        // --- Speech Recognition Logic ---
        if (!SpeechRecognition) {
            statusDiv.textContent = "Speech Recognition not supported by this browser. Try latest Chrome or Edge.";
            statusDiv.style.backgroundColor = "#f8d7da"; 
            statusDiv.style.color = "#721c24";
            if(startButton) startButton.disabled = true;
            if(stopButton) stopButton.disabled = true;
            if(newSectionButton) newSectionButton.disabled = true;
        } else {
            recognition = new SpeechRecognition();
            recognition.continuous = true; 
            recognition.interimResults = false; 
            recognition.lang = 'en-US'; // Consider making this configurable later

            recognition.onstart = () => {
                isRecording = true;
                statusDiv.textContent = 'Status: Recording... Speak now!';
                statusDiv.style.backgroundColor = "#d1ecf1"; // Info color while recording
                statusDiv.style.color = "#0c5460";
                startButton.disabled = true;
                stopButton.disabled = false;
                newSectionButton.disabled = false;
            };

            recognition.onresult = (event) => {
                let finalTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript + ' '; 
                    }
                }
                if (finalTranscript.trim()) {
                    const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                    if (notesArea.value.length > 0 && !notesArea.value.endsWith('\n') && !notesArea.value.endsWith(' ')) {
                        notesArea.value += '\n'; 
                    }
                    notesArea.value += `[${timestamp}] ${finalTranscript.trim()}\n`;
                    notesArea.scrollTop = notesArea.scrollHeight;
                    if (genAIInstance) organizeButton.disabled = false;
                }
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event);
                let errorMsg = 'Speech Error: ' + event.error;
                if (event.error === 'no-speech') errorMsg = 'No speech detected. Check microphone or speak louder.';
                if (event.error === 'audio-capture') errorMsg = 'Audio capture error. Check microphone connection/permissions.';
                if (event.error === 'not-allowed') errorMsg = 'Microphone access denied. Please allow in browser settings.';
                statusDiv.textContent = errorMsg;
                statusDiv.style.backgroundColor = "#f8d7da";
                statusDiv.style.color = "#721c24";
                stopRecording(); // This will reset UI states
            };

            recognition.onend = () => {
                // Only update UI if stopRecording() hasn't already been called by a user action or error.
                // isRecording is the flag for this.
                if (isRecording) { 
                    statusDiv.textContent = 'Status: Recording session ended. Click "Start Recording" to begin again.';
                    isRecording = false; 
                    startButton.disabled = false;
                    stopButton.disabled = true;
                    newSectionButton.disabled = true;
                    if (genAIInstance) organizeButton.disabled = notesArea.value.trim().length === 0;
                }
                // Reset status div color if it was in recording state
                if (!isRecording && statusDiv.style.backgroundColor !== "#f8d7da") { // Avoid overwriting error color
                    statusDiv.style.backgroundColor = "#e7f3fe"; // Default idle color
                    statusDiv.style.color = "#0c5460";
                }
            };
        }

        function startRecording() {
            if (!apiKeyInput.value.trim() && GoogleGenerativeAI && genAIInstance === undefined) { // Only warn if SDK loaded but not initialized
                const confirmNoKey = confirm("Gemini API Key not entered. AI organization will be unavailable. Continue with voice recording only?");
                if (!confirmNoKey) {
                    apiKeyInput.focus();
                    return;
                }
            }
             if (recognition && !isRecording) {
                try {
                    recognition.start();
                } catch (e) {
                    console.error("Error starting recognition:", e);
                    statusDiv.textContent = "Error starting recognition: " + e.message;
                    startButton.disabled = false;
                    stopButton.disabled = true;
                    newSectionButton.disabled = true;
                }
            }
        }

        function stopRecording() {
            if (recognition && isRecording) {
                recognition.stop(); // This will trigger onend, where isRecording is checked
            }
            isRecording = false; // Set state immediately
            statusDiv.textContent = 'Status: Idle. Click "Start Recording" to begin.';
            if (statusDiv.style.backgroundColor !== "#f8d7da") { // Avoid overwriting error color
                statusDiv.style.backgroundColor = "#e7f3fe"; // Default idle color
                statusDiv.style.color = "#0c5460";
            }
            startButton.disabled = false;
            stopButton.disabled = true;
            newSectionButton.disabled = true;
            if (genAIInstance) organizeButton.disabled = notesArea.value.trim().length === 0;
        }

        if(startButton) startButton.addEventListener('click', startRecording);
        if(stopButton) stopButton.addEventListener('click', stopRecording);

        if(newSectionButton) {
            newSectionButton.addEventListener('click', () => {
                if (notesArea.value.length > 0 && !notesArea.value.endsWith('\n\n')) {
                    if (!notesArea.value.endsWith('\n')) notesArea.value += '\n';
                }
                const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                notesArea.value += `\n--- NEW SECTION MARKER (${timestamp}) ---\n\n`;
                notesArea.scrollTop = notesArea.scrollHeight;
            });
        }

        if(clearButton) {
            clearButton.addEventListener('click', () => {
                if (confirm("Are you sure you want to clear raw notes?")) {
                    notesArea.value = '';
                    // statusDiv.textContent = 'Status: Raw notes cleared.'; // Keep main status focused on recording
                    if (genAIInstance) organizeButton.disabled = true;
                }
            });
        }

        function downloadText(filenamePrefix, text) {
            if (!text.trim()) {
                alert("Nothing to download!");
                return false;
            }
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            const now = new Date();
            const filenameDate = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
            const filenameTime = `${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}`;
            a.download = `${filenamePrefix}_${filenameDate}_${filenameTime}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href);
            return true;
        }

        if(downloadRawButton) downloadRawButton.addEventListener('click', () => downloadText('raw_notes', notesArea.value));
        if(downloadOrganizedButton) downloadOrganizedButton.addEventListener('click', () => downloadText('organized_notes', organizedNotesArea.value));
        

        // --- Gemini Organization Logic ---
        if(organizeButton) {
            organizeButton.addEventListener('click', async () => {
                if (!genAIInstance) {
                    const reinitialized = initializeGemini(); // Try to init again
                    if (!reinitialized) {
                         alert("Gemini is not initialized. Please check your API Key and ensure the AI SDK loaded correctly (check console for errors if persists).");
                         return;
                    }
                    // If reinitialized successfully, genAIInstance is now set.
                }
                const rawNotes = notesArea.value.trim();
                if (!rawNotes) {
                    alert("No raw notes to organize.");
                    return;
                }

                geminiStatusEl.textContent = "Organizing notes with Gemini... Please wait.";
                geminiStatusEl.classList.remove('error', 'success');
                organizedNotesArea.value = "Processing with AI, this may take a moment...";
                organizeButton.disabled = true;

                try {
                    const model = genAIInstance.getGenerativeModel({ model: "gemini-1.5-flash-latest" });

                    const prompt = `
You are an expert note-taking assistant. Your task is to transform a raw, timestamped audio transcript into well-structured, easily digestible notes. The primary audience for these notes is someone reviewing material from a lecture, meeting, or personal recording.

Prioritize clarity, conciseness, and actionable insights.

**Instructions:**

1.  **Overall Summary (If Applicable):** If the transcript is sufficiently long or covers multiple distinct ideas, begin with a brief 2-3 sentence executive summary of the entire content.
2.  **Main Topics/Themes:**
    *   Identify and delineate the main topics or themes discussed. Use Markdown H2 (##) or H3 (###) for section headings.
    *   "NEW SECTION MARKER" in the transcript is a strong cue for a topic change. Also, infer topic shifts from the content itself.
3.  **Key Information per Topic:**
    *   Under each topic, extract key points, definitions, critical statements, decisions made, and important examples.
    *   Use bullet points (* or -) or numbered lists for these details.
    *   Employ **bold text** for crucial terms, names, or concepts.
4.  **Action Items:**
    *   If any explicit or clearly implied action items are present (e.g., "we need to do X," "John will follow up on Y"), collate them into a dedicated "Action Items" section at the end of the notes.
    *   Each action item should be clear and, if possible, assignable.
5.  **Clarity and Conciseness:**
    *   Remove conversational filler (ums, uhs, likes, you knows) and redundant phrases.
    *   Rephrase sentences for better readability and grammatical correctness where necessary, without altering the core meaning.
6.  **Timestamp Handling:**
    *   Generally, omit the original timestamps from the organized notes.
    *   Only include a timestamp if it's critically relevant to a specific point (e.g., a deadline mentioned, or a specific time a decision was made).
7.  **Formatting:**
    *   Stick to simple Markdown: Headings, bold, italics, bullet/numbered lists.
    *   Avoid HTML or overly complex formatting.
    *   Ensure good spacing between sections and points for readability.

**Input Transcript:**
--- START OF TRANSCRIPT ---
${rawNotes}
--- END OF TRANSCRIPT ---

**Output (Organized Notes):**
`;

                    const result = await model.generateContent(prompt);
                    const response = await result.response;
                    const text = response.text();
                    
                    organizedNotesArea.value = text;
                    geminiStatusEl.textContent = "Notes organized successfully!";
                    geminiStatusEl.classList.add('success');

                } catch (error) {
                    console.error("Error calling Gemini API:", error);
                    organizedNotesArea.value = `Error: Could not organize notes.\n${error.message}\n\nCheck browser console (F12) for more details. Common issues: Invalid API Key, quota exceeded, network problem, or AI model issue.`;
                    geminiStatusEl.textContent = "Error organizing notes. See details in text area and console.";
                    geminiStatusEl.classList.add('error');
                } finally {
                    if (genAIInstance) organizeButton.disabled = notesArea.value.trim().length === 0;
                }
            });
        }

        // --- Initial Load & UI State ---
        function initializeApp() {
            if (GoogleGenerativeAI) {
                loadApiKey(); // This will also try to initializeGemini if key exists
            } else {
                // SDK failed to load, message already set
                if (apiKeyStatus) apiKeyStatus.textContent = "AI features disabled as AI SDK failed to load.";
                if (organizeButton) organizeButton.disabled = true;
            }

            // Set initial button states
            if (newSectionButton) newSectionButton.disabled = !isRecording;
            if (organizeButton && !genAIInstance) organizeButton.disabled = true;
            else if (organizeButton) organizeButton.disabled = notesArea.value.trim().length === 0;

            if (statusDiv) statusDiv.textContent = "Status: Idle. Enter API Key (optional for basic recording) & Click 'Start Recording'.";
        }

        initializeApp(); // Call on script load

    </script>
</body>
</html>