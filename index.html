<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OraScribe - Intelligent Note Taker</title>
    <style>
        /* ... (All CSS from the previous working version remains the same) ... */
        :root {
            --brand-gradient-start: #FF8C00; --brand-gradient-mid: #FF4500; --brand-gradient-end: #DC143C;
            --accent-color-primary: var(--brand-gradient-mid); --accent-color-secondary: #E03E00;
            --bg-main: #f8f9fa; --bg-card: #ffffff; --bg-input: #f1f3f5; --bg-input-focus: #ffffff;
            --text-dark: #212529; --text-muted: #6c757d; --text-on-accent: #ffffff;
            --border-color: #dee2e6; --border-focus: var(--accent-color-primary);
            --success-green: #28a745; --error-red: #dc3545; --info-blue: #007bff;
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --border-radius: 10px; --shadow-md: 0 4px 8px rgba(0,0,0,0.07); --shadow-lg: 0 8px 16px rgba(0,0,0,0.07);
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: var(--font-family); background-color: var(--bg-main); color: var(--text-dark);
            line-height: 1.6; display: flex; flex-direction: column; align-items: center;
            justify-content: center; min-height: 100vh; padding: 20px;
        }
        .app-shell {
            width: 100%; max-width: 440px; background-color: var(--bg-card);
            border-radius: var(--border-radius); box-shadow: var(--shadow-lg);
            padding: 30px; overflow: hidden; border: 1px solid var(--border-color);
        }
        .screen { display: none; flex-direction: column; align-items: center; width: 100%;}
        .screen.active { display: flex; }
        .screen h1, .screen h2 {
            font-size: 1.7em; font-weight: 600; margin-bottom: 15px;
            color: var(--text-dark); text-align: center;
        }
        .screen p.subtitle {
            color: var(--text-muted); text-align: center; margin-top: -5px;
            margin-bottom: 20px; font-size: 0.95em;
        }
        #screen-apikey label { font-size: 0.9em; color: var(--text-muted); margin-bottom: 8px; width: 100%; }
        #apiKeyInput {
            width: 100%; padding: 12px 16px; border: 1px solid var(--border-color);
            border-radius: 8px; margin-bottom: 12px; font-size: 1em;
            background-color: var(--bg-input); color: var(--text-dark);
        }
        #apiKeyInput::placeholder { color: var(--text-muted); opacity: 0.7;}
        #apiKeyInput:focus {
            outline: none; border-color: var(--border-focus); background-color: var(--bg-input-focus);
            box-shadow: 0 0 0 3px rgba(255, 69, 0, 0.2);
        }
        #apiKeyStatus { font-size:0.85em; color:var(--text-muted); margin-bottom: 20px; width:100%; text-align: left;}

        .live-transcription-box {
            width: 100%; height: 80px; background-color: var(--bg-input);
            border: 1px solid var(--border-color); border-radius: 8px;
            padding: 10px 12px; margin-bottom: 20px; overflow-y: auto;
            font-size: 0.9em; color: var(--text-dark); line-height: 1.4;
        }
        .live-transcription-box:empty::before {
            content: "Live transcription will appear here..."; color: var(--text-muted); font-style: italic;
        }
        .timer-display { font-size: 2.5em; font-weight: 700; color: var(--text-dark); margin-bottom: 15px; }

        .recording-controls { display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 20px; }
        .control-button {
            width: 56px; height: 56px; border-radius: 50%;
            background-color: var(--bg-input); color: var(--accent-color-primary);
            border: 1px solid var(--border-color); display: flex; align-items: center;
            justify-content: center; cursor: pointer; transition: all 0.2s; box-shadow: var(--shadow-md);
        }
        .control-button svg { width: 24px; height: 24px; fill: currentColor; }
        .control-button:hover:not(:disabled) { background-color: #e9ecef; transform: translateY(-1px); }
        .control-button:active:not(:disabled) { transform: scale(0.95) translateY(0); }

        .control-button.main-record {
            width: 70px; height: 70px;
            background-image: linear-gradient(45deg, var(--brand-gradient-start), var(--brand-gradient-end));
            color: var(--text-on-accent); border: none; animation: none;
        }
        .control-button.main-record.is-pulsing { animation: pulse-animation 1.5s infinite ease-in-out; }
        @keyframes pulse-animation {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 69, 0, 0.5); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 8px rgba(255, 69, 0, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 69, 0, 0); }
        }
        .control-button.main-record svg { width: 30px; height: 30px; }
        .control-button.main-record:hover:not(:disabled) {
            background-image: linear-gradient(45deg, var(--brand-gradient-mid), var(--brand-gradient-end));
            box-shadow: 0 6px 12px rgba(255, 69, 0, 0.3);
        }
        .control-button:disabled {
            background-color: var(--bg-input) !important; color: #adb5bd !important;
            cursor: not-allowed; box-shadow: none; opacity: 0.7; border-color: var(--border-color) !important;
        }
        .control-button.main-record:disabled { background-image: none !important; background-color: #ced4da !important; }

        .action-button {
            width: 100%; padding: 14px 20px;
            background-image: linear-gradient(45deg, var(--brand-gradient-start), var(--brand-gradient-mid));
            color: var(--text-on-accent); border: none; border-radius: 8px;
            font-size: 1.05em; font-weight: 600; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: var(--shadow-md);
        }
        .action-button:hover:not(:disabled) {
             background-image: linear-gradient(45deg, var(--brand-gradient-mid), var(--brand-gradient-end));
             transform: translateY(-2px); box-shadow: 0 6px 12px rgba(255, 69, 0, 0.2);
        }
        .action-button:disabled {
            background-image: none !important; background-color: #ced4da !important;
            color: var(--text-muted) !important; cursor: not-allowed;
        }
        .action-button svg { width: 18px; height: 18px; fill: currentColor;}
        .helper-text {
            font-size: 0.9em; color: var(--text-muted); margin-top: 16px;
            display: flex; align-items: center; gap: 6px;
        }
        .helper-text svg { width: 16px; height: 16px; fill: var(--accent-color-primary); }

        #screen-style .style-list {
            width: 100%; display: flex; flex-direction: column; gap: 10px;
            margin-bottom: 24px; max-height: 220px; overflow-y: auto; padding-right: 5px;
        }
        .style-option {
            display: flex; align-items: center; padding: 14px;
            border: 1px solid var(--border-color); border-radius: 8px;
            cursor: pointer; transition: all 0.2s; gap: 12px; background-color: var(--bg-input);
        }
        .style-option:hover { border-color: var(--accent-color-primary); background-color: #fff; }
        .style-option.selected {
            border-color: var(--accent-color-primary); background-color: #fff;
            box-shadow: 0 0 0 2px var(--accent-color-primary);
        }
        .style-option svg { width: 22px; height: 22px; fill: var(--accent-color-primary); flex-shrink: 0; }
        .style-option div h3 { font-size: 1em; font-weight: 500; color: var(--text-dark); margin-bottom: 2px;}
        .style-option div p { font-size: 0.8em; color: var(--text-muted); margin-bottom: 0; text-align: left;}
        
        .navigation-buttons { display: flex; width: 100%; gap: 12px; }
        .navigation-buttons .action-button { flex-grow: 1; }
        .navigation-buttons .action-button.secondary {
            background-image: none; background-color: var(--bg-card);
            color: var(--accent-color-primary); border: 1px solid var(--accent-color-primary);
        }
         .navigation-buttons .action-button.secondary:hover:not(:disabled) {
            background-color: #fff5f0; color: var(--accent-color-secondary);
        }
        .spinner {
            width: 44px; height: 44px; border: 4px solid #ffc999;
            border-top-color: var(--accent-color-primary); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        #screen-result .result-icon { width: 50px; height: 50px; fill: var(--success-green); margin-bottom: 16px; }
        #screen-result .result-icon.error { fill: var(--error-red); }
        
        .result-output-area { /* Common styling for both textareas on result screen */
            width: 100%; min-height: 120px; max-height: 200px; overflow-y: auto;
            padding: 10px 12px; border: 1px solid var(--border-color);
            border-radius: 8px; margin-bottom: 10px; font-size: 0.9em;
            background-color: var(--bg-input); color: var(--text-dark); line-height: 1.5;
        }
        .result-output-area::placeholder { color: var(--text-muted); opacity: 0.7;}
        #screen-result label {
            font-size: 0.85em; font-weight: 500; color: var(--text-muted);
            margin-bottom: 5px; display: block; width: 100%; text-align: left;
        }
        #screen-result .navigation-buttons { margin-top: 15px; } /* Add margin above buttons */

        .api-status-toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(20px);
            padding: 12px 24px; border-radius: 8px; font-size: 0.9em; z-index: 1000;
            opacity: 0; transition: opacity 0.3s, transform 0.3s; pointer-events: none;
            box-shadow: var(--shadow-lg); color: var(--text-on-accent);
        }
        .api-status-toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .api-status-toast.success { background-color: var(--success-green); }
        .api-status-toast.error { background-color: var(--error-red); }
        .api-status-toast.info { background-color: var(--info-blue); }
    </style>
</head>
<body>
    <div class="app-shell">
        <!-- SCREEN 0: API KEY INPUT -->
        <div id="screen-apikey" class="screen active">
            <h1>Welcome to OraScribe</h1><p class="subtitle">Unlock AI-powered note organization. Your key is stored locally.</p>
            <label for="apiKeyInput">Gemini API Key:</label><input type="password" id="apiKeyInput" placeholder="Paste your Google Gemini API Key">
            <div id="apiKeyStatus"></div><button id="saveApiKeyAndProceedButton" class="action-button">Save & Continue</button>
            <button id="skipApiKeyButton" class="action-button secondary" style="margin-top:10px;">Use without AI</button>
        </div>
        <!-- SCREEN 1: RECORDING -->
        <div id="screen-record" class="screen">
            <h2>Record Audio</h2><div id="liveTranscriptionPreview" class="live-transcription-box"></div>
            <div class="timer-display" id="timerDisplay">00:00</div>
            <div class="recording-controls">
                <button class="control-button" id="deleteButton" title="Clear Current Recording" disabled><svg viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg></button>
                <button class="control-button main-record" id="recordPauseButton" title="Start Recording">
                    <svg id="micIcon" viewBox="0 0 20 20"><path d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4z"></path><path fill-rule="evenodd" d="M5.5 8a.5.5 0 000 1h1.333A4.002 4.002 0 0010 11.833a4.002 4.002 0 003.167-1.833H14.5a.5.5 0 000-1h-.5A4.5 4.5 0 0110 12.5a4.5 4.5 0 01-3.5-1.5h-1zM10 15a1 1 0 001-1v-1.167A5.965 5.965 0 0110 12.9c-1.09 0-2.1-.296-2.931-.801L6.936 13A5.978 5.978 0 014 10V8a1 1 0 10-2 0v2a8 8 0 007 7.938V19H7a1 1 0 100 2h6a1 1 0 100-2h-2v-1.062A8.001 8.001 0 0016 10V8a1 1 0 10-2 0v2a5.97 5.97 0 01-2.936 5.199L13 12.833V14a1 1 0 001 1h.5a.5.5 0 000-1H14v-1a3 3 0 10-6 0v1h-.5a.5.5 0 000 1H8a1 1 0 001-1v-1.167A5.965 5.965 0 0110 12.9c1.09 0 2.1-.296 2.931-.801L13.064 13A5.978 5.978 0 0116 10V8a1 1 0 10-2 0v2a8 8 0 00-7-7.938V1H9a1 1 0 100-2h2a1 1 0 100 2h-1v1.062A8.001 8.001 0 004 10V8a1 1 0 10-2 0v2z" clip-rule="evenodd"></path></svg>
                    <svg id="pauseIcon" style="display:none;" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                </button>
                <button class="control-button" id="playButtonPlaceholder" title="Play Recording (Feature Coming Soon)" disabled><svg viewBox="0 0 20 20"><path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"></path></svg></button>
            </div>
            <button id="continueToStyleButton" class="action-button" disabled>Process Recording</button>
            <div class="helper-text"><svg viewBox="0 0 20 20"><path d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4z"></path><path fill-rule="evenodd" d="M5.5 8a.5.5 0 000 1h1.333A4.002 4.002 0 0010 11.833a4.002 4.002 0 003.167-1.833H14.5a.5.5 0 000-1h-.5A4.5 4.5 0 0110 12.5a4.5 4.5 0 01-3.5-1.5h-1zM10 15a1 1 0 001-1v-1.167A5.965 5.965 0 0110 12.9c-1.09 0-2.1-.296-2.931-.801L6.936 13A5.978 5.978 0 014 10V8a1 1 0 10-2 0v2a8 8 0 007 7.938V19H7a1 1 0 100 2h6a1 1 0 100-2h-2v-1.062A8.001 8.001 0 0016 10V8a1 1 0 10-2 0v2a5.97 5.97 0 01-2.936 5.199L13 12.833V14a1 1 0 001 1h.5a.5.5 0 000-1H14v-1a3 3 0 10-6 0v1h-.5a.5.5 0 000 1H8a1 1 0 001-1v-1.167A5.965 5.965 0 0110 12.9c1.09 0 2.1-.296 2.931-.801L13.064 13A5.978 5.978 0 0116 10V8a1 1 0 10-2 0v2a8 8 0 00-7-7.938V1H9a1 1 0 100-2h2a1 1 0 100 2h-1v1.062A8.001 8.001 0 004 10V8a1 1 0 10-2 0v2z" clip-rule="evenodd"></path></svg>Click mic. Saved recording loads if present.</div>
        </div>
        <!-- SCREEN 2: CHOOSE STYLE (HTML same) -->
        <div id="screen-style" class="screen">
            <h2>Processing Options</h2><div class="style-list">
                <div class="style-option selected" data-style="gemini_organize"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M16.9,7.28C16.9,7.28 16.9,7.28 16.9,7.28C16.47,7.78 16.13,8.37 15.9,9H13V7H14.75C14.36,6.37 13.85,5.83 13.24,5.41C12.62,5 11.93,4.73 11.18,4.62L10.9,3.17C12.2,3.33 13.37,3.86 14.37,4.69C15.37,5.5 16.17,6.56 16.9,7.28M7.1,7.28C7.83,6.56 8.63,5.5 9.63,4.69C10.63,3.86 11.8,3.33 13.1,3.17L12.82,4.62C12.07,4.73 11.38,5 10.76,5.41C10.15,5.83 9.64,6.37 9.25,7H11V9H8.1C7.87,8.37 7.53,7.78 7.1,7.28M12,10A2,2 0 0,0 10,12A2,2 0 0,0 12,14A2,2 0 0,0 14,12A2,2 0 0,0 12,10M19,12A7,7 0 0,1 12,19C10.5,19 9.13,18.5 7.95,17.67L6.5,19.12L6.22,17.66C4.67,16.67 3.5,15.22 3.12,13.5H4.9C5.23,14.56 5.91,15.5 6.82,16.18L8.27,14.73L9.72,16.18L10.4,15.5C10.13,15 10,14.5 10,14A4,4 0 0,1 14,10C14.5,10 15,10.13 15.5,10.4L16.18,9.72L14.73,8.27L16.18,6.82C15.5,5.91 14.56,5.23 13.5,4.9V3.12C15.22,3.5 16.67,4.67 17.66,6.22L19.12,6.5L17.67,7.95C18.5,9.13 19,10.5 19,12Z" /></svg><div><h3>Organize with OraScribe AI</h3><p>AI-powered structuring for clear, actionable notes.</p></div></div>
                <div class="style-option" data-style="raw_transcript"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M14,10H19.5L14,4.5V10M5,3C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V9L15,3H5M5,5H13V11H19V19H5V5M7,13H17V15H7V13M7,17H17V19H7V17Z" /></svg><div><h3>View Raw Transcript</h3><p>Get the direct speech-to-text output as is.</p></div></div>
            </div><div class="navigation-buttons"><button id="backToRecordButton" class="action-button secondary">Back</button><button id="processTranscriptButton" class="action-button">Process</button></div>
        </div>
        <!-- SCREEN 3: LOADING (HTML same) -->
        <div id="screen-loading" class="screen">
            <div class="spinner"></div><h2 id="loadingTitle">Processing your audio...</h2><p class="subtitle">This may take a few moments.</p>
        </div>
        <!-- SCREEN 4: RESULT -->
        <div id="screen-result" class="screen">
            <svg class="result-icon" id="resultIcon" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
            <h2 id="resultTitle">Success!</h2>
            
            <label for="aiOrganizedOutput">AI Organized Notes:</label>
            <textarea id="aiOrganizedOutput" class="result-output-area" readonly placeholder="AI organized notes will appear here..."></textarea>
            
            <label for="rawTranscriptOutput" style="margin-top: 15px;">Original Raw Transcript:</label>
            <textarea id="rawTranscriptOutput" class="result-output-area" readonly placeholder="Your original raw transcript..."></textarea>

            <div class="navigation-buttons">
                <button id="newNoteButton" class="action-button secondary">New Note</button>
                <button id="downloadOrganizedNotesButton" class="action-button">Download Organized</button>
                <button id="downloadRawNotesButton" class="action-button secondary" style="margin-top:0;">Download Raw</button>
            </div>
        </div>
    </div><div id="apiStatusToast" class="api-status-toast"></div>

    <script type="module">
        // --- OraScribe Application Logic ---
        // Variables and DOM elements (mostly same as previous)
        // Add new DOM elements for result screen
        const aiOrganizedOutput = document.getElementById('aiOrganizedOutput');
        const rawTranscriptOutput = document.getElementById('rawTranscriptOutput');
        const downloadOrganizedNotesButton = document.getElementById('downloadOrganizedNotesButton');
        const downloadRawNotesButton = document.getElementById('downloadRawNotesButton');
        // Remove transcriptionOutput from main const list as it's now split
        
        let GoogleGenerativeAI, genAIInstance, SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition, recognition,
            isRecording = false, currentTranscript = "", recordingTimerInterval, recordingStartTime, useAI = false, selectedStyle = "gemini_organize",
            livePreviewBuffer = "";

        const screens = { /* ... same ... */
            apikey: document.getElementById('screen-apikey'), record: document.getElementById('screen-record'),
            style: document.getElementById('screen-style'), loading: document.getElementById('screen-loading'),
            result: document.getElementById('screen-result'),
        };
        const apiKeyInput = document.getElementById('apiKeyInput'), apiKeyStatusEl = document.getElementById('apiKeyStatus'),
            saveApiKeyAndProceedButton = document.getElementById('saveApiKeyAndProceedButton'), skipApiKeyButton = document.getElementById('skipApiKeyButton'),
            liveTranscriptionPreview = document.getElementById('liveTranscriptionPreview'),
            timerDisplay = document.getElementById('timerDisplay'), recordPauseButton = document.getElementById('recordPauseButton'),
            micIcon = document.getElementById('micIcon'), pauseIcon = document.getElementById('pauseIcon'),
            deleteButton = document.getElementById('deleteButton'), continueToStyleButton = document.getElementById('continueToStyleButton'),
            styleOptions = document.querySelectorAll('#screen-style .style-option'), backToRecordButton = document.getElementById('backToRecordButton'),
            processTranscriptButton = document.getElementById('processTranscriptButton'), loadingTitle = document.getElementById('loadingTitle'),
            resultTitle = document.getElementById('resultTitle'), resultIconEl = document.getElementById('resultIcon'),
            /* transcriptionOutput removed */ newNoteButton = document.getElementById('newNoteButton'),
            /* downloadNotesButton renamed/split */ apiStatusToast = document.getElementById('apiStatusToast');
        const transcriptStorageKey = 'orascribe_savedTranscript_v2'; // Increment version for any structural changes

        // --- All JS functions (showScreen, SDK, Gemini, Timer, Pulsing, Speech Rec) remain the same ---
        // ... (No changes to the core logic of these functions from previous correct version) ...
        function showScreen(screenId) {Object.values(screens).forEach(s=>s.classList.remove('active')); if(screens[screenId])screens[screenId].classList.add('active');}
        async function loadAndInitializeSDK(){try{const m=await import('https://esm.run/@google/generative-ai');GoogleGenerativeAI=m.GoogleGenerativeAI;return true}catch(e){console.error("SDK Load:",e);showToast("AI SDK fail.","error");return false}}
        function initializeGemini(key){if(!GoogleGenerativeAI){showToast("AI SDK N/A.","error");return false}if(!key){showToast("API Key?","error");return false}try{genAIInstance=new GoogleGenerativeAI(key);showToast("OraScribe AI Ready!","success");useAI=true;return true}catch(e){console.error("Gemini Init:",e);showToast(`AI Init: ${e.message}`,"error");useAI=false;return false}}
        saveApiKeyAndProceedButton.addEventListener('click',async ()=>{const k=apiKeyInput.value.trim();if(k){const s=await loadAndInitializeSDK();if(s&&initializeGemini(k)){localStorage.setItem('orascribe_geminiApiKey',k);apiKeyStatusEl.textContent="API Key saved.";showScreen('record');loadSavedTranscript()}else{apiKeyStatusEl.textContent="API Key invalid/AI fail."}}else{apiKeyStatusEl.textContent="Enter API Key."}});
        skipApiKeyButton.addEventListener('click',()=>{useAI=false;showToast("No AI.","info");showScreen('record');loadSavedTranscript()});
        (async()=>{const k=localStorage.getItem('orascribe_geminiApiKey');if(k){apiKeyInput.value=k;const s=await loadAndInitializeSDK();if(s)initializeGemini(k);apiKeyStatusEl.textContent=k?"API Key loaded.":"Enter API Key."}else{apiKeyStatusEl.textContent="Enter API Key for AI."}loadSavedTranscript()})();
        function loadSavedTranscript(){const s=localStorage.getItem(transcriptStorageKey);if(s){currentTranscript=s;liveTranscriptionPreview.textContent=currentTranscript;if(liveTranscriptionPreview.textContent)liveTranscriptionPreview.scrollTop=liveTranscriptionPreview.scrollHeight;deleteButton.disabled=false;continueToStyleButton.disabled=false;showToast("Prev rec loaded.","info")}else{liveTranscriptionPreview.textContent="";deleteButton.disabled=true;continueToStyleButton.disabled=true}}
        function startTimer(){recordingStartTime=Date.now();timerDisplay.textContent="00:00";recordingTimerInterval=setInterval(()=>{const e=Math.floor((Date.now()-recordingStartTime)/1000);timerDisplay.textContent=`${String(Math.floor(e/60)).padStart(2,'0')}:${String(e%60).padStart(2,'0')}`},1000)}
        function stopTimer(){clearInterval(recordingTimerInterval)}
        function updatePulsingState(r){if(r)recordPauseButton.classList.add('is-pulsing');else recordPauseButton.classList.remove('is-pulsing')}
        if(!SpeechRecognition){recordPauseButton.disabled=true;document.querySelector('#screen-record .helper-text').textContent="Speech Rec N/A."}else{recognition=new SpeechRecognition();recognition.continuous=true;recognition.interimResults=true;recognition.lang='en-US';recognition.onstart=()=>{isRecording=true;micIcon.style.display='none';pauseIcon.style.display='inline';recordPauseButton.title="Pause";deleteButton.disabled=true;continueToStyleButton.disabled=true;startTimer();updatePulsingState(true);currentTranscript="";livePreviewBuffer="";liveTranscriptionPreview.textContent="Listening..."};recognition.onresult=e=>{let n="",t="";for(let o=e.resultIndex;o<e.results.length;++o){const c=e.results[o][0].transcript;e.results[o].isFinal?(currentTranscript+=c+" ",t+=c+" "):n+=c}t&&(livePreviewBuffer+=t,livePreviewBuffer=livePreviewBuffer.replace(/\s+/g," ").trim()+(n?" ":""));liveTranscriptionPreview.textContent=livePreviewBuffer+n;if(liveTranscriptionPreview.textContent)liveTranscriptionPreview.scrollTop=liveTranscriptionPreview.scrollHeight};recognition.onerror=e=>{console.error("Speech Error:",e);showToast(`Speech Error: ${e.error}`,"error");if(isRecording)recognition.stop()};recognition.onend=()=>{isRecording=false;micIcon.style.display='inline';pauseIcon.style.display='none';recordPauseButton.title="Record";const e=currentTranscript.trim().length>0;deleteButton.disabled=!e;continueToStyleButton.disabled=!e;stopTimer();updatePulsingState(false);livePreviewBuffer=currentTranscript.trim();liveTranscriptionPreview.textContent=livePreviewBuffer;if(livePreviewBuffer)liveTranscriptionPreview.scrollTop=liveTranscriptionPreview.scrollHeight;e?localStorage.setItem(transcriptStorageKey,currentTranscript.trim()):localStorage.removeItem(transcriptStorageKey)}}
        recordPauseButton.addEventListener('click',()=>{if(!SpeechRecognition)return;if(isRecording)recognition.stop();else try{localStorage.removeItem(transcriptStorageKey);currentTranscript="";livePreviewBuffer="";liveTranscriptionPreview.textContent="Listening...";recognition.start()}catch(e){console.error("Start Rec Error:",e);showToast("Mic perm?","error")}});
        deleteButton.addEventListener('click',()=>{if(isRecording)return;currentTranscript="";livePreviewBuffer="";timerDisplay.textContent="00:00";liveTranscriptionPreview.textContent="";deleteButton.disabled=true;continueToStyleButton.disabled=true;localStorage.removeItem(transcriptStorageKey);showToast("Rec cleared.","info")});
        continueToStyleButton.addEventListener('click',()=>{if(currentTranscript.trim().length>0)showScreen('style');else showToast("No rec.","info")});
        styleOptions.forEach(e=>e.addEventListener('click',()=>{styleOptions.forEach(e=>e.classList.remove('selected'));e.classList.add('selected');selectedStyle=e.dataset.style}));
        backToRecordButton.addEventListener('click',()=>{showScreen('record');liveTranscriptionPreview.textContent=currentTranscript.trim();if(liveTranscriptionPreview.textContent)liveTranscriptionPreview.scrollTop=liveTranscriptionPreview.scrollHeight;const e=currentTranscript.trim().length>0;deleteButton.disabled=!e||isRecording;continueToStyleButton.disabled=!e||isRecording});
        
        processTranscriptButton.addEventListener('click', async () => {
            resultIconEl.classList.remove('error');
            // The raw transcript is ALREADY in currentTranscript and shown in liveTranscriptionPreview
            // So, we directly populate rawTranscriptOutput on the result screen.
            rawTranscriptOutput.value = currentTranscript.trim();

            if (selectedStyle === "gemini_organize") {
                if (!useAI || !genAIInstance) {
                    showToast("OraScribe AI not ready. Check API Key.", "error");
                    aiOrganizedOutput.value = "AI processing skipped: AI not initialized."; // Inform user
                    showScreen('result'); // Still show result screen with raw transcript
                    return;
                }
                showScreen('loading'); loadingTitle.textContent = "OraScribe AI is processing...";
                aiOrganizedOutput.value = "Processing with AI..."; // Placeholder
                try {
                    const model = genAIInstance.getGenerativeModel({ model: "gemini-1.5-flash-latest" });
                    const prompt = `
You are "OraScribe AI", an expert in transforming raw audio transcripts into exceptionally structured notes.
**Core Directives for OraScribe Notes:**
1.  **Executive Summary (If >150 words):** Concise 2-3 sentence overview.
2.  **Topic Hierarchy:** Use Markdown H2 (## Main Topic) and H3 (### Sub-Topic).
3.  **Details:** Bullet points (* or -) or numbered lists. **Bold** crucial terms. *Italics* for nuance.
4.  **Action Items & Decisions:** Collate under "Action Items" (H2) and/or "Decisions Log" (H2) at the end.
5.  **Refinement:** Remove filler, rephrase for clarity, professional tone.
6.  **Timestamps:** Omit unless critically relevant.
7.  **Formatting:** Simple Markdown. Good spacing.
**Input Transcript:**\n--- START OF TRANSCRIPT ---\n${currentTranscript.trim()}\n--- END OF TRANSCRIPT ---\n
**Output (OraScribe AI Processed Notes):**`;
                    const result = await model.generateContent(prompt);
                    const text = result.response.text(); // Ensure this is .text() for Gemini
                    aiOrganizedOutput.value = text; 
                    resultTitle.textContent = "OraScribe AI Complete!";
                } catch (error) {
                    console.error("OraScribe Gemini API Error:", error); console.dir(error);
                    let detailedErrorMessage = error.message || "Unknown API error occurred.";
                    if (error.toString().includes("API key not valid")) detailedErrorMessage = "API key not valid. Check key & API enablement.";
                    else if (error.toString().includes("billing")) detailedErrorMessage = "Billing issue. Check Google Cloud project billing.";
                    else if (error.toString().includes("quota")) detailedErrorMessage = "Quota exceeded. Check API usage quotas.";
                    
                    aiOrganizedOutput.value = `Error: AI could not process notes.\nDetails: ${detailedErrorMessage}\n\nCommon Checks: See console (F12) for more.`;
                    resultTitle.textContent = "OraScribe AI Failed!"; resultIconEl.classList.add('error');
                    showToast("AI processing error. See details.", "error");
                }
            } else if (selectedStyle === "raw_transcript") {
                // Raw transcript is already set in rawTranscriptOutput above.
                // aiOrganizedOutput can be cleared or state "Raw transcript selected".
                aiOrganizedOutput.value = "(Raw transcript viewing selected - no AI organization performed)";
                resultTitle.textContent = "Raw Transcript Ready!";
            }
            showScreen('result');
        });

        newNoteButton.addEventListener('click', () => { /* ... (same, ensures localStorage cleared) ... */
            currentTranscript = ""; livePreviewBuffer = ""; timerDisplay.textContent = "00:00";
            liveTranscriptionPreview.textContent = ""; aiOrganizedOutput.value = ""; rawTranscriptOutput.value = "";
            deleteButton.disabled = true; continueToStyleButton.disabled = true;
            localStorage.removeItem(transcriptStorageKey);
            const savedApiKey = localStorage.getItem('orascribe_geminiApiKey');
            if (!useAI && !savedApiKey) showScreen('apikey'); else showScreen('record');
        });

        function downloadTextFile(filenamePrefix, textContent) {
            if (!textContent.trim()) { showToast("No content to download.", "info"); return; }
            const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            const now = new Date();
            a.download = `OraScribe_${filenamePrefix}_${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}.txt`;
            a.click(); URL.revokeObjectURL(a.href); a.remove();
            showToast(`${filenamePrefix.replace(/_/g, ' ')} downloaded!`, "success");
        }

        downloadOrganizedNotesButton.addEventListener('click', () => downloadTextFile('Organized_Notes', aiOrganizedOutput.value));
        downloadRawNotesButton.addEventListener('click', () => downloadTextFile('Raw_Transcript', rawTranscriptOutput.value));

        let toastTimeout; function showToast(message, type = "info") { /* ... (same) ... */
            apiStatusToast.textContent = message;
            apiStatusToast.className = 'api-status-toast'; apiStatusToast.classList.add(type, 'show');
            clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => apiStatusToast.classList.remove('show'), 3500);
        }
    </script>
</body>
</html>
